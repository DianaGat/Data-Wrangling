# Data wrangling and analysis, Spring 2022
# University of Helsinki

### Week 5: Statistical procedures (1/2) ----

# set working directory
setwd("Z:/Documents/STUFF/O/DWA/DWA2022/koodeja")
library(tidyverse)

# For this session I'll create a restricted data (country=Finland and 
# some variables are included). Start data is the previous week's datafile
load("ess_w4.Rda") # load last week's data

ess_w5 <- ess_w4 %>% filter(cntry == "FI") %>% 
  select(., idno, cntry, agea, happy, gndr, trust_SUM, trust_AVG)


# create new variables: agef and happyf

ess_w5 <- ess_w5 %>% 
  mutate(agef = cut(agea, breaks=c(0,63,Inf), labels=c(" - 63", "64 - ")))
# check result!
table(ess_w5$agef, useNA = "ifany")

# Hint. Check tabyl() in package janitor
#library(janitor)
#tabyl(ess_w5$agef, show_na=TRUE)


# note. cut intervals (a,b]
ess_w5 <- ess_w5 %>% 
  mutate(happyf = cut(happy, breaks=c(-1,1,3,6,8,10), labels=c("0-1", "2-3", "4-6", "7-8", "9-10")))
# check result!
table(ess_w5$happyf, ess_w5$happy)      
table(ess_w5$happyf, useNA = "ifany")

# Cross tabulation
(t1 <- table(ess_w5$gndr, ess_w5$happyf)) # Note. Small frequencies in some cells.
?prop.table
    prop.table(t1)
prop.table(t1,1)
prop.table(t1,2)

# X^2-test
# H0: gender and happiness are statistically independent
# H1: gender and happiness are not statistically independent
chisq.test(ess_w5$gndr, ess_w5$happyf)

#ess_w5 %>%
#  tabyl(gndr, happyf, show_na=F) %>% chisq.test() 

# observed vs. expected frequencies
results_chi1 <- chisq.test(ess_w5$happyf, ess_w5$gndr)
results_chi1$observed
results_chi1$expected
#results_chi1$residuals
#results_chi1$stdres
# cell contributions:
cell_contrib <- (results_chi1$observed - results_chi1$expected)^2/results_chi1$expected
round(cell_contrib, 4)
# Visualize the cell contributions
library(corrplot)
corrplot(cell_contrib, is.cor = FALSE)

# Some graphics of cross tabulation table (contengency table)
library(gplots)
balloonplot(t(t1), main ="happiness and gender", xlab ="", ylab="",
            label = FALSE, show.margins = TRUE)

library(graphics)
mosaicplot(t1, shade = TRUE, las=2,
           main = "happiness and gender")



### Statistical Procedures: measurement level continuous 

# Often there are need to test if some variable is normally distributed. This can be 
# studied using plots (e.g. histogram) or applying some statistical test.

hist(ess_w5$trust_AVG)

# histogram with normal curve
x <- ess_w5$trust_AVG; s <- sd(x, na.rm = TRUE); m <- mean(x, na.rm = TRUE)
hist(ess_w5$trust_AVG, probability=TRUE)
curve(dnorm(x, mean=m, sd=s), add=TRUE)

# qqplot 
library(car)
qqPlot(ess_w5$trust_AVG)


# a statistical test
# H0: variable is normally distributed
shapiro.test(ess_w5$trust_AVG) # cannot run if the sample size exceeds 5000
ks.test(x = ess_w5$trust_AVG, y = pnorm)


# Test means

# Test some fixed value
# H0: mu = 5, H1: mu ne 5 (two sided test)
t.test(ess_w5$trust_AVG, mu = 5)

# Let's study trust by gender
# H0: mu1 = mu2, H1: mu1 ne mu2
# males and females separately:
trust_AVG_males <- ess_w5  %>% filter(gndr == 1) %>% select(trust_AVG)
trust_AVG_females <- ess_w5  %>% filter(gndr == 2) %>% select(trust_AVG)

# test first the equality of variances
var.test(trust_AVG ~ gndr, data = ess_w5)
# The p-value of F-test is p = 0.406. Itâ€™s higher than e.g. the significance level alpha = 0.05. 
# There is not significant difference between the variances of the two sets of data. Therefore, 
# we can use the classic t-test witch assume equality of the two variances.

# Compute unpaired two-samples t-test
t.test(trust_AVG_males, trust_AVG_females, var.equal = TRUE)


# From previous runs we know that variable trust_AVG is not normally distributed.
# 
# If variable is not normally distributed, non-parametric tests
# can be applied. Let's use Mann-Whitney -test (test for location).

wilcox.test(ess_w5$trust_AVG ~ ess_w5$gndr)
