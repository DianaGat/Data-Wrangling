---
title: "Week 6 report"
author: "Diana Hilleshein"
date: "2/22/2022"
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
output: pdf_document
---
# Preparations  
```{r}
setwd("C:/R scripts/DWA2022")
library(haven)

# import data
data <- read_sav("C:/R scripts/DWA2022/ESS9e03_1.sav")


save(data,file="data.csv")
head(data)
dim(data)#everything is right
```
As well as in a demo file, I will create the restricted data. I beleive it will will significantly increase speed of processing. We soulc remember, that img_avg will be a depended variable.  
Used for *img_avg* variables:
- *imsmetn* -Allow many/few immigrants of same race/ethnic group as majority (scale from 1 to 4, 1 = Allow many to come and live here, 4 = Allow none)  
- *imdfetn* -Allow many/few immigrants of different race/ethnic group from majority (scale from 1 to 4, 1 = Allow many to come and live here, 4 = Allow none)  
- *impcntr* -Allow many/few immigrants from poorer countries outside Europe (scale from 1 to 4, 1 = Allow many to come and live here, 4 = Allow none)  
*General information on a participants*  
1) *stflife* -How satisfied with life as a whole (from 0 to 10, 0 = extremely dissatisfied, 10 = extremely satisfied)  
2) *gndr*-Gender (1 = Male, 2 = Female)  
3) *agea* -Age of respondent, calculated (integer)  
4) *cntry* - Country of respondent (AT = Austria, BE = Belgium, BG = Bulgaria, CH = Switzerland, CY = Cyprus,  CZ = Czechia, DE = Germany, DK = Denmark, EE = Estonia, ES = Spain, FI = Finland, FR = France, GB = United Kingdom, HR = Croatia, HU = Hungary, IE = Ireland, IS = Iceland, IT = Italy, LT = Lithuania,  LV = Latvia, ME = Montenegro, NL = Netherlands, NO = Norway, PL = Poland, PT = Portugal, RS = Serbia,  SE = Sweden, SI = Slovenia, SK = Slovakia)  
5) *idno* - id number
```{r}
library(tidyverse)
library(dplyr)
library(ggplot2)

#create mean var
data$img_avg <- rowMeans(select(data, imwbcnt, imbgeco, imueclt), na.rm = TRUE)
head(data$img_avg)

data6 <- data %>% filter(cntry == "FI") %>% 
  select(., idno, cntry, agea, gndr, img_avg, stflife, ppltrst, polintr)
head(data6)
dim(data6)
```
For ANOVA analysis we need to have more than 3 categories in the variable.
```{r}
data6 <- data6 %>% 
  mutate(age3cat = cut(agea, breaks=c(0,39,65,Inf), labels=c("young", "middle-aged", "old")))
# check result!
table(data6$age3cat, useNA = "ifany")
```
We got number of cases in each age category.
```{r}
# histograms by groups for img_avg


``` 

Vissual I can see that the histogram has a tail that goes to left. I will test if the data normally distributed.
```{r}
#testing for normal distribution
library(ggpubr)
ggqqplot(data6$img_avg)
```
Dots are not following like entirely, going out of confidence intervals on both ends.  
```{r}
#testing for normal distribution
ks.test(data6$img_avg, "pnorm")
```
As the p-value is smaller than 0.05, I reject the normality hypothesis. Therefore, I need to use the nonparametric version, the kruskal.test function: <https://rc2e.com/linearregressionandanova#recipe-id231>   
```{r}
# H0: The mean is the same for all groups
# H1: At least the mean of one group is different
kruskal.test(data6$img_avg ~ data6$age3cat)
```
Conventionally, p = 0.346 indicates that there is no a significant difference between the medians of three age groups. I don`t need to perform multiple pairwise-comparison, but I will do it as I am interested

(alternative: p = 0.05 indicates that there is a significant difference between the medians of three age groups. But we don’t know which pairs of groups are different. Next we will perform multiple pairwise-comparison  to determine if the mean difference between specific pairs of group are statistically significant: <https://www.spcforexcel.com/knowledge/comparing-processes/bonferronis-method>)
```{r}
#multiple pairwise-comparison with bonferroni adj
# pairwise t test with Bonferroni adjustment
#H0: There is no difference  in satisafction between youn, middle-age and old groups 
#H1: There is change in satisafction between young, middle-age and old groups 

## for normal distribution
#pairwise.t.test(data6$sat_avg, data6$age3cat, p.adj = "bonf")
#data6 %>% pairwise_t_test(sat_avg ~ age3cat, paired = TRUE, p.adjust.method = "bonferroni") #didnt work
# anotehr way
library(tidyverse)
library(ggpubr)
library(rstatix)

pairwise.wilcox.test(data6$img_avg, data6$age3cat, p.adjust.method = "bonferroni")
```
There rae no statistically significnat results.
```{r}
library(summarytools)
with(data6,
stby(data=data6$img_avg,
INDICES=data6$age3cat, #form froups by gender => male/female ==> find summaries of social trust for each group
FUN=descr,
stats=c("mean","sd","min","med","max","skewness"))) 
```
Multiple pairwise-comparison test indicates that there are no significnat differences between medians.
```{r}
# some figures and plots
data6 %>% group_by(age3cat)  %>% 
  summarise(n = n(), mean_img_avg = mean(img_avg, na.rm = TRUE),
            sd_img_avg = sd(img_avg, na.rm = TRUE))

ggplot(data6, aes(x = age3cat, y = img_avg, fill = age3cat)) +
  geom_boxplot() 
```
# Linear regression model  
Checking correlations  

Variables:  
- *stflife* -How satisfied with life as a whole (from 0 to 10, 0 = extremely dissatisfied, 10 = extremely satisfied)   
- *agea* -Age of respondent, calculated (integer)   
- *gndr*-Gender (1 = Male, 2 = Female)   
- *cntry* - Country of respondent (AT = Austria, BE = Belgium, BG = Bulgaria, CH = Switzerland, CY = Cyprus,  CZ = Czechia, DE = Germany, DK = Denmark, EE = Estonia, ES = Spain, FI = Finland, FR = France, GB = United Kingdom, HR = Croatia, HU = Hungary, IE = Ireland, IS = Iceland, IT = Italy, LT = Lithuania,  LV = Latvia, ME = Montenegro, NL = Netherlands, NO = Norway, PL = Poland, PT = Portugal, RS = Serbia,  SE = Sweden, SI = Slovenia, SK = Slovakia)  
- *polintr* -How interested in politics (from 1 to 4, 1= Very interested ... 4 = Not at all)  
- *imwbcnt* -Immigrants make country worse or better place to live (scale from 0 to 10, 0 = Worse place to live, 10 = Better place to live)  
- *ppltrst* - Most people can be trusted or you can't be too careful (from 0 to 10, 0 = You can't be too careful ... 10 = people can be trusted)

Scales go from negative to positive for sat_avg and imbgeco, so we do not need to recode them. Scale for polintr does not have positive or negative meaning.
```{r}
#corrmatrix <- cor(select(data6, img_avg, stflife, agea, gndr, cntry, polintr, ppltrst), use="complete.obs")
#corrmatrix
# gives me a mistake: "cor(data6, use = "complete.obs") : 'x' must be numeric"

sapply(data6, is.numeric) #checking wich columns are not appropriate//makes sence that cntry are not acceptable XD
corrmatrix <- cor(select(data6, img_avg, stflife, agea, gndr, polintr, ppltrst), use="complete.obs")
corrmatrix

#what happens if I use NAs
cor(select(data6, img_avg, agea, gndr, polintr)) #not good
```
Correlations:  

- stflife & **img_avg** (r= 0.215) - the more people satisfied with life and government, the more they accept immigration
- **img_avg** & ppltrst (r = 0.326) - the more people accept immigrants, the more people trust other people  
- **img_avg** & polintr (r = -0.208) - the more people accept immigrants, the lest they interested in politics
- stflife & ppltrst (r = 0.243) - the more people satisfied with life and government, the more they trust other people  

```{r}
# a plot
library(corrplot)
corrplot(corrmatrix)


```
```{r}
# linear regression with one predictor
# Scatter plot
ggplot(data6, aes(x = ppltrst, y = img_avg)) +
  geom_point()
```
I can see that it follows a line/pattern.  
```{r}
# Sometimes some jittering (in Finnish: täristää) is needed.
ggplot(data6, aes(x = ppltrst, y = img_avg)) +
  geom_point(position = "jitter")
```
"It is typically used to better visualize overlapping values, such as integer covariates. This helps grasp where the density of observations is high." <= <https://stackoverflow.com/questions/17547699/what-does-the-jitter-function-do-in-r#:~:text=Jittering%20indeed%20means%20just%20adding,amount%2Dparameter%20is%20not%20provided>  
I guess we can see that the plot is skewed: the density ob observations is bigger from 5 to 8 on the ppltrst scale and from 5 to 8 on the img_avg scale. In other words the majority of answers are located in upper right corner that is above median. 

```{r}
# add regression line and e.g. just part of the data (persons under 30 years old)
data6 %>% filter(agea <= 30) %>% 
  ggplot(., aes(x = ppltrst, y = img_avg)) +
  geom_point(position = "jitter") +
  geom_smooth(method = lm)
```

# Regression model  

```{r}
# At first a simple regression model
lm1 <- lm(img_avg ~ ppltrst, data = data6)
summary(lm1)
```
A nice hint from Maria: Hint. For model comparison use AIC and/or BIC. The model with the lowest AIC and BIC score is preferred.
```{r}
AIC(lm1) 
BIC(lm1)
```

```{r}
# Add second predictor
lm2 <- lm(img_avg ~ ppltrst + stflife, data = data6)
summary(lm2)

AIC(lm2) 
BIC(lm2)
```
```{r}
lm3 <- lm(img_avg ~ ppltrst + stflife + ppltrst, data = data6)
summary(lm3)

AIC(lm3) #smaller then the previous values
BIC(lm3)
```
```{r}
lm4 <- lm(img_avg ~ stflife, data = data6)
summary(lm4)

AIC(lm4) 
BIC(lm4)
```

The model 2 and 3 gave the smallest AIC/BIC values. I would prefer the model 3 since all the predictors are statistically significnat in it.

R Squared is showing proportion of variance in the dependent variable that can be explained by the independent variables. Adjusted R squared is modified version of R**2 that was adjusted for the number of predictors in the model. Looking at the output of the model, I can conclude that the model explains 12.6% of the proportion of the variance or 12.5% for Adjusted R Squared.  

The equation for the model is “img_avg = 2.489+ (0.314 * "ppltrst") + (0.179* "stflife"). The model is statistically significant (p < 0.05). The model shows that with the increase of ppltrst and stflife by 1, the img_avg is increasing by 0.493 and the img_avg value would be 2.982.

It means that with increase of trust in people and satisfaction with life and governement policy by one unit, the acceptance of immigrants is increased by 0.493 units.
```{r}
cor(select(data6, stflife, ppltrst), use="complete.obs")
```
Note, that with increase in satisfaction with life and governement policy, there si increase in people trust. The predictors are correlated.

## Diagnostic
```{r}
# diagnostic plots
layout(matrix(c(1,2,3,4),2,2)) # optional 4 graphs/page
plot(lm3)
```
Looking at the Residual vs Fitted plot, I can say that there is some pattern in how the residuals are spreaded, they are more frequent between 6 and 7 on fitted residuals axis. Also, points on theleft seem to be too lonely. Normal Q-Q plot shows that the fit to the normal distribution is not perfect, point follow the line, but violate it on the ends. Looking at the Residuals vs Leverage plot, we conclude that there can be few observation that stands out significantly (on the right side of the plot), but they doent seem to affect the fit line strongly.

```{r}
# Test Normality of Residuals
# H0: residuals are normally distributed

hist(lm3$residuals)
```
As I said, the residuals seem to be skewed to right.
```{r}
ks.test(x = lm3$residuals, y = pnorm)
```
As the p-value is smaller than 0.05, I reject the normality hypothesis.